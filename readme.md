# koishi-plugin-rate-limit

[![npm](https://img.shields.io/npm/v/koishi-plugin-rate-limit?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-rate-limit)
[![GitHub](https://img.shields.io/github/stars/YisRime?style=flat-square)](https://github.com/YisRime)

限制指令和中间件的调用频率和每日调用次数。

## ✨ 功能特性

**🎯 双重目标**：同时支持对 **指令 (Command)** 和 **中间件 (Middleware)** 进行限制。
**🔧 灵活配置**：可对每个指令单独设置频率限制（冷却时间）、每日使用次数上限。
**🌐 统一范围控制**：支持以 **用户 (user)**、**频道 (channel)** 或 **全局 (global)** 为单位，统一管理所有频率限制的范围。
**💬 智能提示**：可配置在触发限流时，是否向用户发送人性化的提示信息。
**⚖️ 规则系统**：通过强大的规则列表，实现对指令的白名单（豁免）和黑名单（限制）功能。
**🔍 正则匹配**：可针对消息内容，通过正则表达式进行中间件限流，有效防止刷屏。

## ⚙️ 插件配置

插件的配置分为三个主要部分：**基础设置**、**指令限制** 和 **中间件限制**。

### 1. 基础设置

这些是本插件的核心设置，用于控制全局行为。

**`scope`**: `(user | channel | global)` 统一的频率限制范围。此设置将同时应用于所有受限的指令和中间件。

- `user`：针对单个用户进行限制（默认）。
- `channel`：针对单个频道进行限制。
- `global`：全局共享同一个限制计数。

**`sendHint`**: `(布尔值)` 当用户操作被限流时，是否发送提示信息。开启后会发送“操作过于频繁...”等提示，关闭则静默处理（默认关闭）。

### 2. 指令限制

这部分配置用于控制**指令 (Command)** 的调用。

**`defaultAction`**: `(limit | ignore)` 默认行为，决定了本插件对指令是作为黑名单还是白名单工作。

- `limit`: **黑名单模式（默认）**。默认限制所有目标，`例外列表` 用于设置“豁免”的特例。
- `ignore`: **白名单模式**。默认不限制任何目标，`例外列表` 用于设置需要“限制”的特例。

**`commandRules`**: `(数组)` 例外列表。列表中的每一项都定义了一个豁免或限制的规则。

- **`type`**: `(user | channel)` 匹配类型（`用户 ID` 或 `频道 ID`）。
- **`content`**: `(字符串)` 要匹配的具体内容（用户 ID 或频道 ID）。

#### 单个指令的配置

要对某个特定的指令进行频率或次数限制，你需要进入该指令自身的配置页面。在 Koishi 中，通常路径是 `Koishi 控制台 -> 插件 -> command`，然后找到目标指令。

**`maxUsage`**: 该指令的每日最大使用次数。设置为 0 则不限制。
**`minInterval`**: 该指令的最小调用间隔（单位：秒），即冷却时间 (Cooldown)。设置为 0 则不限制。

---

#### 示例 1：豁免管理员调用所有指令

假设你想限制所有用户，但豁免管理员（QQ号：`12345678`），可以这样配置：

1. 在 `指令限制` 部分，设置 `defaultAction`: `limit` (默认限制所有人)。
2. 在 `commandRules` (例外列表) 中添加一条规则：
    - `type`: `user` (按用户ID匹配)
    - `content`: `1234f-8`

#### 示例 2：让 `echo` 指令每用户每 10 秒只能用一次

1. 在 `基础设置` 中，确保 `scope` 设置为 `user`。
2. 前往 `echo` 指令自身的配置，设置：
    - `maxUsage`: `0`
    - `minInterval`: `10`

---

### 3. 中间件限制

这部分配置用于限制非指令的普通消息（如纯文本聊天），常用于防止刷屏。

**`limitMiddleware`**: `(布尔值)` 总开关，是否对非指令消息启用频率限制（默认关闭）。

**`middlewareRules`**: `(数组)` 规则列表。只有匹配了规则列表中的内容，才会触发中间件限制。每一项都是一个独立的规则对象。

- **`content`**: `(字符串)` 用于匹配消息内容的**正则表达式**。
- **`maxUsage`**: `(数字)` 匹配该规则后，每日最大使用次数（0为不限制）。
- **`minInterval`**: `(数字)` 匹配该规则后，连续调用最小间隔（秒，0为不限制）。

#### 示例 3：限制包含“晚安”的消息刷屏

假设你想限制包含“晚安”的消息，每个用户 1 小时只能发一次：

1. 在 `基础设置` 中，确保 `scope` 设置为 `user`。
2. 在 `中间件限制` 部分，设置 `limitMiddleware: true` (开启中间件限制)。
3. 在 `middlewareRules` (规则列表) 中添加一条规则：
    - `content`: `晚安`  (这里会作为正则表达式来匹配消息)
    - `maxUsage`: `0`  (不限制每日总次数)
    - `minInterval`: `3600`  (限制冷却时间为 3600 秒)
